---
title: "Tufte Handout"
author: "John Smith"
date: "August 13th, 2014"
output: rmarkdown::tufte_handout
---

```{r options, cache = FALSE, echo=FALSE, include=FALSE}

packrat::off()

# set global chunk optionsrm(list=ls(all=TRUE)) #start with empty workspace
rm(list=ls(all=TRUE)) #start with empty workspace

startTime <- Sys.time()

knitr::opts_chunk$set(cache = TRUE, echo = FALSE, include = FALSE)

doInstall <- FALSE # Change to TRUE if you do want packages installed.
toInstall <- c( "data.table", "tidyr", "dplyr", "ggplot2", "scales","sampling")

if (doInstall) {install.packages(toInstall, repos = "http://cran.us.r-project.org")}
lapply(toInstall, library, character.only = TRUE)

setwd("C:/Users/e551910/Google Drive/SSAMasterFile/") # set the working directory
list.files() # see whats there

load("lifeCyclErnnRiskRData.RData")

```

```{r import data, eval=FALSE}

# this if to replicate this study
# https://www.newyorkfed.org/medialibrary/media/research/staff_reports/sr710.pdf

temp <- tempfile()

download.file("https://www.socialsecurity.gov/policy/docs/microdata/epuf/epuf2006_csv_files.zip",
               quiet = TRUE, 
              destfile = temp)

con <- unzip(temp)

# take a look at the files on the data
con

ptm <- proc.time()
  
dataAnnual <- fread(con[1], 
                    header = T,
                    verbose = FALSE,
                    sep = ',',
                    showProgress = TRUE)

proc.time() - ptm

```

```{r getUniqueSample, eval = FALSE}


### download CPI data

# https://research.stlouisfed.org/fred2/series/CPIAUCSL/downloaddata
# or here
# http://download.bls.gov/pub/time.series/cw/cw.data.0.Current

# calculate real wages

# http://www.cpwr.com/sites/default/files/annex_how_to_calculate_the_real_wages.pdf

wagesCPI <- fread("./CPIAUCSL.csv") %>%
  mutate(Year = substr(DATE, 1, 4) ) %>%
  group_by(Year) %>%
  slice(1)

dataAnnual <- dataAnnual %>%
  as.data.frame() %>%
  left_join(wagesCPI,
            by = c("YEAR_EARN" = "Year")) %>%
  select(-DATE) %>%
  mutate(ANNUAL_EARNINGS = as.integer(ANNUAL_EARNINGS),
         realWage = (ANNUAL_EARNINGS / VALUE)*100) %>%
  as.data.table()

CountsByYear <- dataAnnual %>%
  select(ID, YEAR_EARN) %>%
  group_by(YEAR_EARN) %>%
  summarise(count = n()) %>%
  arrange(YEAR_EARN)

# library(devtools)
# source_gist(6424112)

IDbyFirstYear <- dataAnnual %>% 
  select(ID, YEAR_EARN) %>%
  #mutate(YEAR_EARN = as.integer(YEAR_EARN)) %>%
  arrange(ID, YEAR_EARN) %>%
  group_by(ID) %>%
  slice(1)

set.seed(1)

sampleRecords <- IDbyFirstYear %>%
  group_by(YEAR_EARN) %>%
  do(sample_n(., 1200)) %>%
  select(ID)

# match the sample to the orig data

dataAnnualSampleSet <- left_join(sampleRecords, dataAnnual,
                                 by = c("ID" = "ID")) %>%
  as.data.frame() %>%
  dplyr::select(ID, YEAR_EARN = YEAR_EARN.y, ANNUAL_EARNINGS, ANNUAL_QTRS, realWage)

# options(dplyr.print_max = 1e9) 

# calculate the years reported

dataAnnualSampleSetSummarized <- dataAnnualSampleSet %>%
  select(ID, YEAR_EARN) %>%
  mutate(YEAR_EARN = as.integer(YEAR_EARN)) %>%
  group_by(ID) %>%
  mutate(minYear = min(YEAR_EARN),
         maxYear = max(YEAR_EARN)) %>%
  select(ID,minYear, maxYear) %>%
  distinct() %>%
  mutate(Years = maxYear - minYear) %>%
  select(ID, minYear, Years) %>%
  ungroup() %>%
  as.data.table()

# expand the data and merge it with the orig data

dataAnnualSampleSetLong <- dataAnnualSampleSetSummarized[,.(Year=minYear+0:(Years-1)), ID] %>%
  mutate(YEAR_EARN = as.character(Year)) %>%
  left_join(dataAnnual) %>%
  group_by(ID) %>%
  arrange(Year) %>%
  mutate(PriorYearEarnings = lag(realWage),
         fivePriorYearEarnings = lag(realWage,5),
         PriorYearDiff = realWage - PriorYearEarnings,
         FiveYearDiff = realWage - fivePriorYearEarnings)

hist(dataAnnualSampleSetLong$PriorYearEarnings)

dpriorYear <- density(dataAnnualSampleSetLong$PriorYearEarnings, 
             bw = "sj",
             na.rm = TRUE)
dpriorYear

dpriorFiveYears <- density(dataAnnualSampleSetLong$FiveYearDiff, 
             bw = "sj",
             na.rm = TRUE)
dpriorFiveYears


```

```{r plotEarningsDensity, eval=FALSE}

par(mfrow=c(2,1))

plot(dpriorYear)
plot(dpriorFiveYears)

par(mfrow=c(1,1)

## add normal density curve

```

```{r getDemographicData, eval=FALSE}

rm(dataAnnual)

dataDemographics <- fread(con[2], header = T, sep = ',')

demographicWithSample <- left_join(dataAnnualSampleSetLong,
                                   dataDemographics) %>%
  mutate(FiveYearPrcnChng  =  FiveYearDiff/realWage ) %>%
  group_by(YEAR_EARN) %>%
  mutate(FiveYearPrcnChngRank =  cume_dist(FiveYearPrcnChng),
         FiveYearPrcnChngRankGroups = cut(FiveYearPrcnChngRank, # make groups 
                                          #breaks = c(0,.24,.49,.75,1),
                                          breaks = seq(0, 1, 0.25),
                                          #labels = c("0-.24",".25-.5",".51-.75","1"), 
                                          include.lowest = TRUE),
         ANNUAL_EARNINGSRank =  cume_dist(ANNUAL_EARNINGS),
         ANNUAL_EARNINGSRankGroups = cut(ANNUAL_EARNINGSRank, # make groups 
                                         #breaks = c(0,.24,.49,.75,1),
                                         breaks = seq(0, 1, 0.25),
                                         #labels = c("0-.24",".25-.5",".51-.75","1"), 
                                         include.lowest = TRUE),
         fivePriorYearEarningsRank =  cume_dist(fivePriorYearEarnings),
         fivePriorYearEarningsRankGroups = cut(fivePriorYearEarningsRank, # make groups 
                                               #breaks = c(0,.24,.49,.75,1),
                                               breaks = seq(0, 1, 0.25),
                                               #labels = c("0-.24",".25-.5",".51-.75","1"), 
                                               include.lowest = TRUE))

unlink("./EPUF2006_ANNUAL.csv")

unlink("./EPUF2006_DEMOGRAPHIC.csv")

# remove all the objects exept one

rm(list=setdiff(ls(), "demographicWithSample"))

# add age of earner 

demographicWithSample <- demographicWithSample %>%
mutate(YOB = as.integer(YOB),
       AgeEarnings = Year - YOB)

save.image(file = "lifeCyclErnnRiskRData.RData")

```

```{r plotHistogramOfScores, eval=FALSE, fig.cap = "Most people make around the same amount of money five years later", message = FALSE, warning = FALSE, include=TRUE}

# http://stackoverflow.com/questions/5688082/ggplot2-overlay-histogram-with-density-curve

demographicWithSample %>%
  ggplot( aes(fivePriorYearEarnings)) +
  geom_histogram(aes(), bins = 100, alpha = 1/3) +
  stat_function(fun = dnorm, 
                na.rm = TRUE,
                args = list(mean = mean(demographicWithSample$fivePriorYearEarnings, 
                                        na.rm = TRUE), 
                            sd = sd(demographicWithSample$fivePriorYearEarnings,
                                    na.rm = TRUE)), 
                #lwd = 1, 
                size = 1,
                alpha = 1/3,
                col = 'red') +
  scale_y_continuous(#trans=log_trans(), 
                     labels = comma) +
  scale_x_continuous(labels = comma) +
  theme_minimal() +
  labs(x = "Five Year Difference", y = "Frequency") 

```


```{r plotHistogramOfScoresByYear, eval=FALSE, fig.cap = "Most people make around the same amount of money five years later", message = FALSE, warning = FALSE, include=TRUE}

# http://stackoverflow.com/questions/5688082/ggplot2-overlay-histogram-with-density-curve

demographicWithSample %>%
  ggplot( aes(PriorYearDiff)) +
  geom_histogram(aes(), bins = 100) +
  facet_wrap(~ Year,  ncol = 7, scales = "free") +
  stat_function(fun = dnorm, 
                na.rm = TRUE,
                args = list(mean = mean(demographicWithSample$PriorYearDiff, 
                                        na.rm = TRUE), 
                            sd = sd(demographicWithSample$PriorYearDiff,
                                    na.rm = TRUE)), 
                #lwd = 1, 
                size = 1,
                alpha = 1/3,
                col = 'red') +
  scale_y_continuous(labels=function(x)x/1000)+
  scale_x_continuous(labels = comma) +
  #coord_cartesian(xlim = c(30000, 30000)) +
  theme_minimal() +
  labs(x = "Prior Year Difference", y = "Frequency (thousands)") +
  theme(
    #panel.grid.major = element_blank(), 
    #panel.grid.minor = element_blank(),
    panel.background = element_rect(colour = "grey90",
                                    size = 1),
    strip.text.x = element_text(size = 4, 
                                colour = "black", 
                                angle = 00 #, lineheight = .5
    ),
    axis.title.x = element_text(size = 8, 
                                angle = 00),
    axis.text.x = element_text(colour = "black", 
                               size = 4, 
                               angle = 90, 
                               vjust = .5),
    axis.title.y = element_text(size = 8, 
                                angle = 90),
    axis.text.y = element_text(colour = "black", 
                               size = 5, 
                               angle = 00, 
                               vjust = .5),
    plot.margin = unit(c(0,0,0,0), "cm"))

```



```{r plot}


makeplot_mosaic <- function(data, x, y, ...){
  xvar <- deparse(substitute(x))
  yvar <- deparse(substitute(y))
  mydata <- data[c(xvar, yvar)];
  mytable <- table(mydata);
  widths <- c(0, cumsum(apply(mytable, 1, sum)));
  heights <- apply(mytable, 1, function(x){c(0, cumsum(x/sum(x)))});

  alldata <- data.frame();
  allnames <- data.frame();
  for(i in 1:nrow(mytable)){
    for(j in 1:ncol(mytable)){
      alldata <- rbind(alldata, c(widths[i], widths[i+1], heights[j, i], heights[j+1, i]));
    }
  }
  colnames(alldata) <- c("xmin", "xmax", "ymin", "ymax")

  alldata[[xvar]] <- rep(dimnames(mytable)[[1]],rep(ncol(mytable), nrow(mytable)));
  alldata[[yvar]] <- rep(dimnames(mytable)[[2]],nrow(mytable));

  ggplot(alldata, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax)) + 
    geom_rect(color="black", aes_string(fill=yvar)) +
    xlab(paste(xvar, "(count)")) + ylab(paste(yvar, "(proportion)"));
}

makeplot_mosaic(demographicWithSample,  SEX, FiveYearPrcnChngRankGroups)


```


```{r plotHistogramOfScoresByYearPercent, eval=FALSE, fig.cap = "Most people make around the same amount of money five years later", message = FALSE, warning = FALSE, include=TRUE}

# http://stackoverflow.com/questions/5688082/ggplot2-overlay-histogram-with-density-curve

demographicWithSample %>%
  ggplot( aes(FiveYearPrcnChng)) +
  geom_histogram(aes(), bins = 100) +
  facet_wrap(~ Year,  ncol = 7, scales = "free") +
  stat_function(fun = dnorm, 
                na.rm = TRUE,
                args = list(mean = mean(demographicWithSample$FiveYearPrcnChng, 
                                        na.rm = TRUE), 
                            sd = sd(demographicWithSample$FiveYearPrcnChng,
                                    na.rm = TRUE)), 
                #lwd = 1, 
                size = 1,
                alpha = 1/3,
                col = 'red') +
  scale_y_continuous(labels=function(x)x/1000)+
  scale_x_continuous(# limits = c(-2,2)
                     labels = percent) +
  coord_cartesian(xlim = c(-10,10)) +
  theme_minimal() +
  labs(x = "Five Year Percent Difference", y = "Frequency (thousands)") +
  theme(
    #panel.grid.major = element_blank(), 
    #panel.grid.minor = element_blank(),
    panel.background = element_rect(colour = "grey90",
                                    size = 1),
    strip.text.x = element_text(size = 4, 
                                colour = "black", 
                                angle = 00 #, lineheight = .5
    ),
    axis.title.x = element_text(size = 8, 
                                angle = 00),
    axis.text.x = element_text(colour = "black", 
                               size = 4, 
                               angle = 90, 
                               vjust = .5),
    axis.title.y = element_text(size = 8, 
                                angle = 90),
    axis.text.y = element_text(colour = "black", 
                               size = 5, 
                               angle = 00, 
                               vjust = .5),
    plot.margin = unit(c(0,0,0,0), "cm"))

```





```{r plotHistogramOfScoresByYearGroup, eval=FALSE, fig.cap = "Most people make around the same amount of money five years later", message = FALSE, warning = FALSE, include=TRUE}

# http://stackoverflow.com/questions/5688082/ggplot2-overlay-histogram-with-density-curve

demographicWithSample %>%
  ggplot( aes(FiveYearPrcnChngRankGroups)) +
  stat_count(width = 0.5) +
  facet_wrap(~ Year,  ncol = 7, scales = "free",  dir = "v") +
  scale_y_continuous(labels=function(x)x/1000) +
  #scale_x_continuous(labels = comma) +
  theme_minimal() +
  labs(x = "Five Year Difference", y = "Frequency (thousands)") +
  theme(
    #panel.grid.major = element_blank(), 
    #panel.grid.minor = element_blank(),
    panel.background = element_rect(colour = "grey90",
                                    size = 1),
    strip.text.x = element_text(size = 4, 
                                colour = "black", 
                                angle = 00 #, lineheight = .5
    ),
    axis.title.x = element_text(size = 8, 
                                angle = 00),
    axis.text.x = element_text(colour = "black", 
                               size = 4, 
                               angle = 90, 
                               vjust = .5),
    axis.title.y = element_text(size = 8, 
                                angle = 90),
    axis.text.y = element_text(colour = "black", 
                               size = 5, 
                               angle = 00, 
                               vjust = .5),
    plot.margin = unit(c(0,0,0,0), "cm"))

```

```{r statSummary}

library(psych)


test <- describeBy(demographicWithSample, 
           demographicWithSample$Year,
           skew=TRUE,
           mat=TRUE,
           ranges=FALSE) 

```



```{r createDeciles, eval=FALSE}

demographicWithSampleTest <- demographicWithSample %>%
  mutate(YOB = as.numeric(YOB),
         AgeEarnings = Year-YOB) %>%
 group_by(YEAR_EARN, AgeEarnings) %>%
  mutate(AnnualRank =  ntile(ANNUAL_EARNINGS, 10),
         FiveYearRank =  ntile(fivePriorYearEarnings, 10),
         YOBrRounded = signif(YOB, 3)) %>%
  droplevels()



library(corrplot)

dataCorrelation <- demographicWithSample %>%
  ungroup() %>%
  mutate(YOB = as.numeric(YOB),
         AnnualRank =  ntile(ANNUAL_EARNINGS, 10),
         FiveYearRank =  ntile(fivePriorYearEarnings, 10),
         YOBrRounded = signif(YOB, 3)) %>%
group_by(YOBrRounded) %>%
summarize(cor(AnnualRank, FiveYearRank, use = "pairwise.complete.obs"))


ggplot(demographicWithSampleTest, aes(AnnualRank, FiveYearRank)) +
  geom_jitter(alpha = 1/10) + stat_smooth() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + 
  #geom_abline(color = "green") +
  facet_wrap(~YOBrRounded)


 ggtitle(paste("Correlation = ",round(cor(demographicWithSampleTest$AnnualRank,demographicWithSampleTest$FiveYearRank),digits=2),sep="")) + 
   
   
```

# Introduction
First, starting with the first moment, we find that average earnings growth over the
life cycle varies strongly with the level of lifetime earnings: the median individual by
lifetime earnings experiences an earnings growth of 38% from ages 25 to 55, whereas for
individuals in the 95th percentile, this figure is 230%; for those in the 99th percentile,
this figure is almost 1500%.3









