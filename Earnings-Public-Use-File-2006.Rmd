---
title: "Tufte Handout"
author: "John Smith"
date: "August 13th, 2014"
output: rmarkdown::tufte_handout
---

```{r options, cache = FALSE, echo=FALSE, include=FALSE}

# set global chunk optionsrm(list=ls(all=TRUE)) #start with empty workspace
rm(list=ls(all=TRUE)) #start with empty workspace

startTime <- Sys.time()

knitr::opts_chunk$set(cache = TRUE, echo = FALSE, include = FALSE)

doInstall <- FALSE # Change to TRUE if you do want packages installed.
toInstall <- c( "data.table", "tidyr", "dplyr", "ggplot2", "scales","RColorBrewer")

if (doInstall) {install.packages(toInstall, repos = "http://cran.us.r-project.org")}
lapply(toInstall, library, character.only = TRUE)

setwd("~/GitHub/Earnings-Public-Use-File-2006/") # set the working directory
list.files() # see whats there

load("lifeCyclErnnRiskRData.RData")
packrat::off()


```

```{r importData, eval=FALSE}

# this if to replicate this study
# https://www.newyorkfed.org/medialibrary/media/research/staff_reports/sr710.pdf

temp <- tempfile()

download.file("https://www.socialsecurity.gov/policy/docs/microdata/epuf/epuf2006_csv_files.zip",
               quiet = TRUE, 
              destfile = temp)

con <- unzip(temp)

# take a look at the files on the data
con

ptm <- proc.time()
  
dataAnnual <- fread(con[1], 
                    header = T,
                    verbose = FALSE,
                    sep = ',',
                    showProgress = TRUE)

proc.time() - ptm

dataDemographics <- fread(con[2], header = T, sep = ',')%>%
  select( -c(TOT_COV_EARN3750, QC3750, QC5152))

### download CPI data

# https://research.stlouisfed.org/fred2/series/CPIAUCSL/downloaddata
# or here
# http://download.bls.gov/pub/time.series/cw/cw.data.0.Current

# to calculate real wages
# import the data and extract the index for each year in January

# http://www.cpwr.com/sites/default/files/annex_how_to_calculate_the_real_wages.pdf

wagesCPI <- fread("./CPIAUCSL.csv") %>%
  mutate(Year = substr(DATE, 1, 4) ) %>%
  group_by(Year) %>%
  slice(1)

```

```{r getUniqueSample, eval = FALSE}

# to get a sample 
# 1. expand the earnings to the max years reported
# 2. join the expanded earnings with the demographics
# 2. get a sample by age starting 20 years old, then at 30, 40, 50, 60
# by year, by gender

EarningsSummarizedByYear <- dataAnnual %>%
  select(ID, YEAR_EARN) %>%
  mutate(YEAR_EARN = as.integer(YEAR_EARN)) %>%
  group_by(ID) %>%
  mutate(minYear = min(YEAR_EARN),
         maxYear = max(YEAR_EARN)) %>%
  select(ID,minYear, maxYear) %>%
  distinct() %>%
  mutate(Years = maxYear - minYear) %>%
  select(ID, minYear, Years)

# take a look at the summirized data

hist(EarningsSummarizedByYear$Years)

boxplot(EarningsSummarizedByYear$Years)

boxplot(EarningsSummarizedByYear$Years, plot = FALSE)

# exclude records that have less than 9 years earnings

EarningsSummarizedByYear <- EarningsSummarizedByYear %>%
  filter(Years > 9)

# expand the data and merge it with the orig data

dataAnnualSampleSetLong <- EarningsSummarizedByYear[,.(Year=minYear+0:(Years-1)), ID] %>%
  mutate(YEAR_EARN = as.character(Year)) %>%
  select(-Year) %>%
  left_join(dataAnnual) %>%
  group_by(ID) %>%
  arrange(YEAR_EARN)

rm(EarningsSummarizedByYear)
gc()

# merge with the demographics data and calc age
# select records that have earings when age is 20 years (before or after ok)
# get the min for each ID
# merge with the expanded earnings set

IDbyFirstYear <- dataAnnual %>% 
  select(ID, YEAR_EARN) %>%
  left_join(dataDemographics) %>%
  select(ID, YEAR_EARN, YOB, SEX) %>%
  mutate(YOB = as.integer(YOB),
         YearEarn = as.integer(YEAR_EARN),
         AgeEarnings = YearEarn - YOB) %>%
  arrange(ID, YEAR_EARN) %>%
  filter(AgeEarnings == 20) %>%
  group_by(ID) %>%
  slice(1)

length((unique(IDbyFirstYear$ID)))

with(IDbyFirstYear, table(YEAR_EARN, SEX, useNA = "ifany" ))

# get a sample of 4000 unique ID by year and gender

set.seed(1)

sampleRecordsFemaleStart20Yrs <- IDbyFirstYear %>%
  filter(SEX == 2) %>%
  group_by(YEAR_EARN) %>%
  do(sample_n(., 4000, replace = FALSE)) %>%
  select(ID) 

with(sampleRecordsFemaleStart20Yrs, table(YEAR_EARN, useNA = "ifany" ))

sampleRecordsMaleStart20Yrs <- IDbyFirstYear %>%
  filter(SEX == 1) %>%
  group_by(YEAR_EARN) %>%
  do(sample_n(., 4000, replace = FALSE)) %>%
  select(ID) %>%
  full_join(sampleRecordsFemaleStart20Yrs) %>%
  select(-YEAR_EARN)

sampleRecordsMaleAndFemaleWithEArningsAt20Yrs <- sampleRecordsMaleStart20Yrs %>%
  inner_join(dataAnnualSampleSetLong) %>%
  left_join(dataDemographics) %>%
  mutate(YOB = as.integer(YOB),
         YearEarn = as.integer(YEAR_EARN),
         AgeEarnings = YearEarn - YOB) %>%
  filter(AgeEarnings > 19)

rm(list=setdiff(ls(),
                c("sampleRecordsMaleAndFemaleWithEArningsAt20Yrs",
                  "wagesCPI",
                  "startTime")))

gc()

# calculate real wages

# http://www.cpwr.com/sites/default/files/annex_how_to_calculate_the_real_wages.pdf

setEveryFithYear <- sampleRecordsMaleAndFemaleWithEArningsAt20Yrs %>%
  group_by(ID) %>% 
  slice(c( seq(1, 60, by=5 ))) %>% # get the earnings
  left_join(wagesCPI,
            by = c("YEAR_EARN" = "Year")) %>%
  select(-DATE) %>%
  mutate(ANNUAL_EARNINGS = as.integer(ANNUAL_EARNINGS),
         realWage = (ANNUAL_EARNINGS / VALUE)*100)

rm(list=setdiff(ls(),
                c("setEveryFithYear",
                  "startTime")))

gc()

summary(setEveryFithYear)

str(setEveryFithYear)

# save.image("./lifeCyclErnnRiskRData.RData")

# remove the SSA data

unlink("./EPUF2006_ANNUAL.csv")

unlink("./EPUF2006_DEMOGRAPHIC.csv")
```


```{r plotHistogramOfScores, eval=FALSE, fig.cap = "Most people make around the same amount of money five years later", message = FALSE, warning = FALSE, include=TRUE}

# http://stackoverflow.com/questions/5688082/ggplot2-overlay-histogram-with-density-curve

colourCount = length(unique(setEveryFithYear$AgeEarnings))
getPalette = colorRampPalette(brewer.pal(8, "Accent"))

setEveryFithYear %>%
  ggplot( aes(realWage, color = as.factor(AgeEarnings))) +
  geom_freqpoly(aes(), bins = 100, alpha = 1/3, position="identity") +
  stat_function(fun = dnorm, 
                na.rm = TRUE,
                args = list(mean = mean(setEveryFithYear$realWage, 
                                        na.rm = TRUE), 
                            sd = sd(setEveryFithYear$realWage,
                                    na.rm = TRUE)), 
                #lwd = 1, 
                size = 1,
                alpha = 1/3,
                col = 'red') +
  scale_y_continuous(#trans=log_trans(), 
    labels = comma) +
  scale_x_continuous(labels = comma) +
  theme_minimal() +
  scale_color_manual(values = getPalette(colourCount),
                     name = "Earnings by year") +
  labs(x = "Earnings", y = "Frequency")

```


```{r plotHistogramOfScoresByYear, eval=FALSE, fig.cap = "Most people make around the same amount of money five years later", message = FALSE, warning = FALSE, include=TRUE}

# http://stackoverflow.com/questions/5688082/ggplot2-overlay-histogram-with-density-curve

setEveryFithYear %>%
  ggplot( aes(realWage, fill = as.factor(AgeEarnings))) +
  geom_histogram(aes(), bins = 100, alpha = 1/3, position="identity") +
  facet_wrap(~ YOB, ncol = 7) +
  stat_function(fun = dnorm, 
                na.rm = TRUE,
                args = list(mean = mean(setEveryFithYear$realWage, 
                                        na.rm = TRUE), 
                            sd = sd(setEveryFithYear$realWage,
                                    na.rm = TRUE)), 
                #lwd = 1, 
                size = 1,
                alpha = 1/3,
                col = 'red') +
  scale_fill_manual(values = getPalette(colourCount),
                     name = "Earnings by year") +
  scale_y_continuous(labels=function(x)x/1000)+
  scale_x_continuous(labels = comma) +
  #coord_cartesian(xlim = c(30000, 30000)) +
  theme_minimal() +
  labs(x = "Earnings by year", y = "Frequency (thousands)") +
  theme(
    #panel.grid.major = element_blank(), 
    #panel.grid.minor = element_blank(),
    panel.background = element_rect(colour = "grey90",
                                    size = 1),
    strip.text.x = element_text(size = 4, 
                                colour = "black", 
                                angle = 00 #, lineheight = .5
    ),
    axis.title.x = element_text(size = 8, 
                                angle = 00),
    axis.text.x = element_text(colour = "black", 
                               size = 4, 
                               angle = 90, 
                               vjust = .5),
    axis.title.y = element_text(size = 8, 
                                angle = 90),
    axis.text.y = element_text(colour = "black", 
                               size = 5, 
                               angle = 00, 
                               vjust = .5),
    plot.margin = unit(c(0,0,0,0), "cm"))



setEveryFithYear %>%
  ggplot( aes(realWage, color = as.factor(AgeEarnings))) +
  geom_freqpoly(aes(), bins = 100, alpha = 1/3, position="identity") +
  facet_wrap(~ YOB, ncol = 10) +
  stat_function(fun = dnorm, 
                na.rm = TRUE,
                args = list(mean = mean(setEveryFithYear$realWage, 
                                        na.rm = TRUE), 
                            sd = sd(setEveryFithYear$realWage,
                                    na.rm = TRUE)), 
                #lwd = 1, 
                size = 1,
                alpha = 1/3,
                col = 'red') +
  scale_colour_manual(values = getPalette(colourCount),
                     name = "Earnings by year") +
  scale_y_continuous(labels=function(x)x/1000)+
  scale_x_continuous(labels = comma) +
  #coord_cartesian(xlim = c(30000, 30000)) +
  theme_minimal() +
  labs(x = "Earnings by year", y = "Frequency (thousands)") +
  theme(
    #panel.grid.major = element_blank(), 
    #panel.grid.minor = element_blank(),
    panel.background = element_rect(colour = "grey90",
                                    size = 1),
    strip.text.x = element_text(size = 4, 
                                colour = "black", 
                                angle = 00 #, lineheight = .5
    ),
    axis.title.x = element_text(size = 8, 
                                angle = 00),
    axis.text.x = element_text(colour = "black", 
                               size = 4, 
                               angle = 90, 
                               vjust = .5),
    axis.title.y = element_text(size = 8, 
                                angle = 90),
    axis.text.y = element_text(colour = "black", 
                               size = 5, 
                               angle = 00, 
                               vjust = .5),
    plot.margin = unit(c(0,0,0,0), "cm"))

```



```{r plot}


makeplot_mosaic <- function(data, x, y, ...){
  xvar <- deparse(substitute(x))
  yvar <- deparse(substitute(y))
  mydata <- data[c(xvar, yvar)];
  mytable <- table(mydata);
  widths <- c(0, cumsum(apply(mytable, 1, sum)));
  heights <- apply(mytable, 1, function(x){c(0, cumsum(x/sum(x)))});

  alldata <- data.frame();
  allnames <- data.frame();
  for(i in 1:nrow(mytable)){
    for(j in 1:ncol(mytable)){
      alldata <- rbind(alldata, c(widths[i], widths[i+1], heights[j, i], heights[j+1, i]));
    }
  }
  colnames(alldata) <- c("xmin", "xmax", "ymin", "ymax")

  alldata[[xvar]] <- rep(dimnames(mytable)[[1]],rep(ncol(mytable), nrow(mytable)));
  alldata[[yvar]] <- rep(dimnames(mytable)[[2]],nrow(mytable));

  ggplot(alldata, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax)) + 
    geom_rect(color="black", aes_string(fill=yvar)) +
    xlab(paste(xvar, "(count)")) + ylab(paste(yvar, "(proportion)"));
}

makeplot_mosaic(demographicWithSample,  SEX, FiveYearPrcnChngRankGroups)


```





```{r statSummary}

library(psych)


test <- describeBy(demographicWithSample, 
           demographicWithSample$Year,
           skew=TRUE,
           mat=TRUE,
           ranges=FALSE) 

```



```{r createDeciles, eval=FALSE}

demographicWithSampleTest <- demographicWithSample %>%
  mutate(YOB = as.numeric(YOB),
         AgeEarnings = Year-YOB) %>%
 group_by(YEAR_EARN, AgeEarnings) %>%
  mutate(AnnualRank =  ntile(ANNUAL_EARNINGS, 10),
         FiveYearRank =  ntile(fivePriorYearEarnings, 10),
         YOBrRounded = signif(YOB, 3)) %>%
  droplevels()



library(corrplot)

dataCorrelation <- demographicWithSample %>%
  ungroup() %>%
  mutate(YOB = as.numeric(YOB),
         AnnualRank =  ntile(ANNUAL_EARNINGS, 10),
         FiveYearRank =  ntile(fivePriorYearEarnings, 10),
         YOBrRounded = signif(YOB, 3)) %>%
group_by(YOBrRounded) %>%
summarize(cor(AnnualRank, FiveYearRank, use = "pairwise.complete.obs"))


ggplot(demographicWithSampleTest, aes(AnnualRank, FiveYearRank)) +
  geom_jitter(alpha = 1/10) + stat_smooth() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + 
  #geom_abline(color = "green") +
  facet_wrap(~YOBrRounded)


 ggtitle(paste("Correlation = ",round(cor(demographicWithSampleTest$AnnualRank,demographicWithSampleTest$FiveYearRank),digits=2),sep="")) + 
   
   
```

# Introduction
First, starting with the first moment, we find that average earnings growth over the
life cycle varies strongly with the level of lifetime earnings: the median individual by
lifetime earnings experiences an earnings growth of 38% from ages 25 to 55, whereas for
individuals in the 95th percentile, this figure is 230%; for those in the 99th percentile,
this figure is almost 1500%.3









